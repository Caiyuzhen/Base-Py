import re
import socket
import sys
import os
import time


# å…¨å±€å˜é‡, è®°å½•è¦æ‰“å¼€çš„æ–‡ä»¶è·¯å¾„
g_document_root = "./html" # æœåŠ¡å™¨æ ¹è·¯å¾„



# ğŸ”¥å¯åŠ¨æœåŠ¡å™¨ä¸»ç¨‹åº
def main():
	# 1. åˆ›å»ºå¥—æ¥å­— = ç»‘å®šç«¯å£ â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”
	server_socket = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
	
	# 2. ç»‘å®šæœ¬åœ°ä¿¡æ¯ (è°ƒç”¨ç­‰å¾…å‡½æ•°ç»‘å®šç«¯å£) â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”
	def wait_for_port_release(port, timeout=60): # ç­‰å¾…å‡½æ•°, ç­‰å¾…ç›´åˆ°ç«¯å£è¢«é‡Šæ”¾
		start_time = time.time()
		while True:
			try:
				server_socket.setsockopt(socket.SOL_SOCKET, socket.SO_REUSEADDR, 1) # ğŸš€ğŸš€ åœ¨ç»‘å®šç«¯å£å‰, å…è®¸ç«¯å£åœ¨æ²¡æœ‰é‡Šæ”¾å¹²å‡€å‰å°±å¯ä»¥å¤ç”¨ !! é˜²æ­¢ç«¯å£è¢«å ç”¨
				server_socket.bind(("localhost", port)) # server_socket.bind(("localhost", 3999)) # ç»‘å®šã€åŸŸåã€‘è·Ÿã€ç«¯å£ã€‘
				break
			except OSError as e:
				if "Address already in use" in str(e) and time.time() - start_time < timeout:
					time.sleep(1)  # æ¯ç§’æ£€æŸ¥ä¸€æ¬¡
				else:
					raise # raise è¡¨ç¤ºæŠ›å‡ºå¼‚å¸¸
	wait_for_port_release(8080)  # æ­¤å¤„ä½¿ç”¨æ‚¨å¸Œæœ›ç­‰å¾…çš„ç«¯å£å·

	# 3. ç›‘å¬å¥—æ¥å­— â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”
	server_socket.listen(128) # 128 è¡¨ç¤ºåŒä¸€æ—¶åˆ»æœ€å¤šå¯ä»¥é“¾æ¥å¤šå°‘ä¸ª (128 ä¸ª) å®¢æˆ·ç«¯
 
	# 4. å¼€å§‹ç›‘å¬, ç­‰å¾…æ–°å®¢æˆ·ç«¯çš„é“¾æ¥ â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”
	while True:
		print("Server is listening on port 8080...")
		new_socket, new_addr = server_socket.accept() # ğŸ”¥ new_socket ä¸ºæ–°çš„å¥—æ¥å­—, new_addr ä¸ºæ–°çš„åœ°å€

		# 5. æ¥æ”¶è¯·æ±‚çš„æ•°æ® â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”
		request = new_socket.recv(1024).decode('utf-8') # 1024 è¡¨ç¤ºæœ¬æ¬¡æ¥æ”¶çš„æœ€å¤§å­—èŠ‚æ•°
		# print(request)
		req_lines = request.splitlines() # ğŸš€ æŠŠè¯·æ±‚æ•°æ®æŒ‰è¡Œåˆ†å‰²æˆåˆ—è¡¨
		for i, line in enumerate(req_lines): # ğŸ”¥ğŸ”¥ enumerate è¡¨ç¤ºæšä¸¾, i è¡¨ç¤ºç´¢å¼•, line è¡¨ç¤ºå…ƒç´ 
			pass
			# print(i, line)

		# 6. æå–è¯·æ±‚çš„æ–‡ä»¶ï¼ˆæ¯”å¦‚ index.htmlï¼‰â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”
		print(req_lines[0]) # GET /index.html HTTP/1.1 => å®Œæ•´çš„è¯·æ±‚æ–‡ä»¶
		ret = re.match(r"([^/]*)([^ ]+)", req_lines[0]) # [^/]*[^ ] è¡¨ç¤ºä»å–å‡ºè·¯å¾„ => /a/b/c/index.html
		if ret:
			print("â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”")
			print("æ­£åˆ™æå–å‡ºçš„æ•°æ®:", ret.group(1)) 
			print("æ­£åˆ™æå–å‡ºçš„æ•°æ®:", ret.group(2)) 
			file_name = ret.group(2) # ğŸ”¥ä¿å­˜è¯·æ±‚çš„æ–‡ä»¶å
   
			if file_name == "/":
				file_name = "/index.html"

			# 7. æ‰“å¼€æ–‡ä»¶, è¯»å–æ–‡ä»¶æ•°æ® â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”
			has_error = False  # æ ‡å¿—, ç”¨äºæŒ‡ç¤ºæ˜¯å¦å‘ç”Ÿå¼‚å¸¸
			f = None  # åˆå§‹åŒ– f å˜é‡, ç”¨äºåˆ¤æ–­æ–‡ä»¶æ˜¯å¦å­˜åœ¨
   
			try:
				file_path = g_document_root + file_name
				if os.path.exists(file_path):
					f = open(file_path, "rb") # ğŸ”¥ rb ç”¨æ¥æ‰“å¼€ã€äºŒè¿›åˆ¶ã€‘æ–‡ä»¶
					content = f.read() # ğŸ”¥ å­˜å‚¨è¯»å–å‡ºæ¥çš„æ–‡ä»¶æ•°æ®
					# ... å…¶ä½™æ–‡ä»¶å¤„ç†ä»£ç 
				else:
					raise Exception("âŒ æ–‡ä»¶ä¸å­˜åœ¨ï½")
			except: # å¦‚æœæœ‰å¼‚å¸¸
				has_error = True
				not_found_header = "HTTP/1.1 404 Not Found\r\nContent-Type: text/plain; charset=utf-8\r\n" # ğŸš€ è®¿é—®çš„åœ°å€ä¸å­˜åœ¨æ—¶çš„å¤„ç†
				not_found_header += "\r\n" # ç©ºæ ¼
				not_found_body = "âŒ Url is not found, è¯·è¾“å…¥æ­£ç¡®çš„ url åœ°å€"
				new_socket.send(not_found_header.encode('utf-8'))
				new_socket.send(not_found_body.encode('utf-8'))
				new_socket.close()
				# pass
			# 8. æŠŠæ•°æ®è¿”å›ç»™æµè§ˆå™¨ (ğŸ”¥ å¦‚æœéœ€è¦å‘é€å“åº”å¤´è·ŸäºŒè¿›åˆ¶æ•°æ®, åˆ™éœ€è¦åˆ†å¼€å‘é€!! å› ä¸ºå­—ç¬¦ä¸²è·ŸäºŒè¿›åˆ¶çš„æ•°æ®æ— æ³•åŒæ—¶å‘é€!!) â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”
			finally: # å¦‚æœæ²¡å¼‚å¸¸
				if not has_error: # åªæœ‰åœ¨æ²¡æœ‰å¼‚å¸¸çš„æƒ…å†µä¸‹æ‰å‘é€æ­£å¸¸çš„å“åº”
					response_header = "HTTP/1.1 200 OK\r\nContent-Type: text/html; charset=utf-8\r\n"  # \r\n è¡¨ç¤ºå›è½¦æ¢è¡Œ, ä¸ºäº†å…¼å®¹ linux, macosx, windows
					response_header += "\r\n" # è¡¨ç¤ºä¸€ä¸ªç©ºè¡Œ, ä½œä¸ºæ¢è¡Œç¬¦
					response_body = content
					# response_body = "ğŸ‘‹ ä½ å¥½ Hello!"
					# response = response_header + response_body # ğŸš€ å‚¨å­˜è¿”å›ç»™æµè§ˆå™¨çš„æ•°æ®

					# 8-1.åˆ†å¼€å‘é€ç»™æµè§ˆå™¨ - å‘é€ header
					new_socket.send(response_header.encode('utf-8')) # ğŸš€ å‘é€ header æ•°æ®ç»™æµè§ˆå™¨

					# 8-1.åˆ†å¼€å‘é€ç»™æµè§ˆå™¨ - å‘é€ body (html é¡µé¢æ•°æ®)
					new_socket.send(response_body) # ğŸš€ å‘é€ html äºŒè¿›åˆ¶æ•°æ®ç»™æµè§ˆå™¨

				# 9. å…³é—­è¿™ä¸ªæ–°å¥—æ¥å­— (ğŸ”¥ new_socket!!)
				new_socket.close()

				if f is not None: # å¦‚æœæ–‡ä»¶å­˜åœ¨
					f.close()


if __name__ == "__main__":
	main()
