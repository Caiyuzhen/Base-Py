import re
import socket
import sys
import os
import time
# from http_page.mini_web import login, register # å¯¼å…¥ login.py, register.py é‡Œçš„å‡½æ•°
from mini_web import application, login, register, detail, wrong_404 # å¯¼å…¥ login.py, register.py é‡Œçš„å‡½æ•°
# references : https://www.bilibili.com/video/BV1KB4y1D7X6?p=8&spm_id_from=pageDriver&vd_source=b67f9398d85e7e297041f47a430b16cb

# å…¨å±€å˜é‡, è®°å½•è¦æ‰“å¼€çš„æ–‡ä»¶è·¯å¾„
# g_document_root = "./html" # æœåŠ¡å™¨æ ¹è·¯å¾„



# ğŸŒŸWSGI æœåŠ¡å™¨ç±»
class WSGIServer():
	""" åˆå§‹åŒ–æœåŠ¡å™¨ """
	def __init__(self, port, documents_root):
		self.documents_root = documents_root #  ğŸ”¥ æœåŠ¡å™¨æ ¹è·¯å¾„
		self.port = port # ğŸ”¥ å­˜æ”¾ç«¯å£å·
    
		# 1. åˆ›å»ºå¥—æ¥å­—  â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”
		self.server_socket = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
  
		# 2. ç»‘å®šæœ¬åœ°ä¿¡æ¯(ç»‘å®šç«¯å£) â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”
		self.server_socket.setsockopt(socket.SOL_SOCKET, socket.SO_REUSEADDR, 1) # ğŸš€ğŸš€ åœ¨ç»‘å®šç«¯å£å‰, å…è®¸ç«¯å£åœ¨æ²¡æœ‰é‡Šæ”¾å¹²å‡€å‰å°±å¯ä»¥å¤ç”¨ !! é˜²æ­¢ç«¯å£è¢«å ç”¨
		self.server_socket.bind(("localhost", self.port)) #server_socket.bind(("localhost", 8080)) # ç»‘å®šã€åŸŸåã€‘è·Ÿã€ç«¯å£ã€‘


		# 3. ç›‘å¬å¥—æ¥å­— â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”
		self.server_socket.listen(128) # 128 è¡¨ç¤ºåŒä¸€æ—¶åˆ»æœ€å¤šå¯ä»¥é“¾æ¥å¤šå°‘ä¸ª (128 ä¸ª) å®¢æˆ·ç«¯
  
		# å®šä¹‰ä¸¤ä¸ªå±æ€§ç”¨æ¥å­˜å‚¨ web æ¡†æ¶ä¼ è¾“è¿‡æ¥çš„ status çŠ¶æ€ç ä»¥åŠ header å“åº”å¤´
		self.status = "" # å­˜å‚¨å­—ç¬¦ä¸²
		self.headers = [] # å­˜å‚¨åˆ—è¡¨
	
 
 
	""" è¿è¡ŒæœåŠ¡å™¨ """
	def run_forever(self):
		# 4. å¼€å§‹ç›‘å¬, ç­‰å¾…æ–°å®¢æˆ·ç«¯çš„é“¾æ¥ â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”
		while True:
			print(f"Server is listening on port {self.port}...")
			self.new_socket, new_addr = self.server_socket.accept() # ğŸ”¥ ç”¨ self æ¥è®©æ•´ä¸ªç±»å…±äº«æ•°æ®!! self.new_socket ä¸ºæ–°çš„å¥—æ¥å­—, new_addr ä¸ºæ–°çš„åœ°å€
			self.deal_with_request() # è°ƒç”¨ä¸‹ä¸€ä¸ªæ–¹æ³•


	""" WSGI ä» Web æ¡†æ¶ä¸­æ¥æ”¶ header çš„è®¾ç½®"""
	def set_status_headers(self, status, headers):
		self.status = status # ğŸ”¥ ä¿å­˜çŠ¶æ€ç  "200 OK"
		self.headers = headers # ğŸ”¥ ä¿å­˜ header å“åº”å¤´, [("Content-Type", "text/html; charset=utf-8")]
	

	""" å¤„ç†è¯·æ±‚ """
	def deal_with_request(self):
		# 5. æ¥æ”¶ web å‘é€è¿‡æ¥çš„ tcp è¯·æ±‚æ•°æ® â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”
		request = self.new_socket.recv(1024).decode('utf-8') # 1024 è¡¨ç¤ºæœ¬æ¬¡æ¥æ”¶çš„æœ€å¤§å­—èŠ‚æ•°
  
		if request: # å¦‚æœæœ‰æ•°æ®
			# print(request)
			req_lines = request.splitlines() # ğŸš€ æŠŠè¯·æ±‚æ•°æ®æŒ‰è¡Œåˆ†å‰²æˆåˆ—è¡¨
			for i, line in enumerate(req_lines): # ğŸ”¥ğŸ”¥ enumerate è¡¨ç¤ºæšä¸¾, i è¡¨ç¤ºç´¢å¼•, line è¡¨ç¤ºå…ƒç´ 
				pass
				# print(i, line)


			# 6. æå–è¯·æ±‚çš„æ–‡ä»¶ï¼ˆæ¯”å¦‚ index.htmlï¼‰â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”
			print(req_lines[0]) # GET /index.html HTTP/1.1 => å®Œæ•´çš„è¯·æ±‚æ–‡ä»¶
			ret = re.match(r"([^/]*)([^ ]+)", req_lines[0]) # [^/]*[^ ] è¡¨ç¤ºä»å–å‡ºè·¯å¾„ => /a/b/c/index.html
			if ret: # å¦‚æœæ­£åˆ™åŒ¹é…æˆåŠŸ, è¡¨ç¤ºæå–åˆ°äº†è¯·æ±‚çš„æ–‡ä»¶å
				print("â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”")
				print("æ­£åˆ™æå–å‡ºçš„æ•°æ®:", ret.group(1)) 
				print("æ­£åˆ™æå–å‡ºçš„æ•°æ®:", ret.group(2)) 
				file_name = ret.group(2) # ğŸ”¥ä¿å­˜è¯·æ±‚çš„æ–‡ä»¶å

				if file_name == "/":
					file_name = "/index.html"

				# ğŸ‘‡å¦‚æœä¸æ˜¯ .py ç»“å°¾çš„è¯·æ±‚, å°±æ˜¯è·å–é™æ€èµ„æº ************************************************************************
				if not file_name.endswith(".py"):
					# 7. æ‰“å¼€æ–‡ä»¶, è¯»å–æ–‡ä»¶æ•°æ® â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”
					has_error = False  # æ ‡å¿—, ç”¨äºæŒ‡ç¤ºæ˜¯å¦å‘ç”Ÿå¼‚å¸¸
					f = None  # åˆå§‹åŒ– f å˜é‡, ç”¨äºåˆ¤æ–­æ–‡ä»¶æ˜¯å¦å­˜åœ¨

					try: # å°è¯•æ‰“å¼€æ–‡ä»¶
						file_path = self.documents_root + file_name
						if os.path.exists(file_path):
							f = open(file_path, "rb") # ğŸ”¥ rb ç”¨æ¥æ‰“å¼€ã€äºŒè¿›åˆ¶ã€‘æ–‡ä»¶
							content = f.read() # ğŸ”¥ å­˜å‚¨è¯»å–å‡ºæ¥çš„æ–‡ä»¶æ•°æ®
							# ... å…¶ä½™æ–‡ä»¶å¤„ç†ä»£ç 
						else:
							raise Exception("âŒ æ–‡ä»¶ä¸å­˜åœ¨ï½")
					except: # ğŸ‘‡ å¦‚æœæœ‰å¼‚å¸¸, æŠŠå¼‚å¸¸æ•°æ®è¿”å›ç»™æµè§ˆå™¨
						has_error = True
						not_found_header = "HTTP/1.1 404 Not Found\r\nContent-Type: text/plain; charset=utf-8\r\n" # ğŸš€ è®¿é—®çš„åœ°å€ä¸å­˜åœ¨æ—¶çš„å¤„ç†
						not_found_header += "\r\n" # ç©ºæ ¼
						not_found_body = "âŒ Url is not found, è¯·è¾“å…¥æ­£ç¡®çš„ url åœ°å€"
						self.new_socket.send(not_found_header.encode('utf-8'))
						self.new_socket.send(not_found_body.encode('utf-8'))
						self.new_socket.close()
						# pass
					finally: # å¦‚æœæ²¡å¼‚å¸¸, æŠŠæ‹¿åˆ°çš„æ–‡ä»¶è¿”å›ç»™æµè§ˆå™¨
						if not has_error: # åªæœ‰åœ¨æ²¡æœ‰å¼‚å¸¸çš„æƒ…å†µä¸‹æ‰å‘é€æ­£å¸¸çš„å“åº”
							# 8. æŠŠæ•°æ®è¿”å›ç»™æµè§ˆå™¨ (ğŸ”¥ å¦‚æœéœ€è¦å‘é€å“åº”å¤´è·ŸäºŒè¿›åˆ¶æ•°æ®, åˆ™éœ€è¦åˆ†å¼€å‘é€!! å› ä¸ºå­—ç¬¦ä¸²è·ŸäºŒè¿›åˆ¶çš„æ•°æ®æ— æ³•åŒæ—¶å‘é€!!) â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”
							response_header = "HTTP/1.1 200 OK\r\nContent-Type: text/html; charset=utf-8\r\n"  # \r\n è¡¨ç¤ºå›è½¦æ¢è¡Œ, ä¸ºäº†å…¼å®¹ linux, macosx, windows
							response_header += "\r\n" # è¡¨ç¤ºä¸€ä¸ªç©ºè¡Œ, ä½œä¸ºæ¢è¡Œç¬¦
							response_body = content
							# response_body = "ğŸ‘‹ ä½ å¥½ Hello!"
							# response = response_header + response_body # ğŸš€ å‚¨å­˜è¿”å›ç»™æµè§ˆå™¨çš„æ•°æ®

							# 8-1.åˆ†å¼€å‘é€ç»™æµè§ˆå™¨ - å‘é€ header
							self.new_socket.send(response_header.encode('utf-8')) # ğŸš€ å‘é€ header æ•°æ®ç»™æµè§ˆå™¨

							# 8-1.åˆ†å¼€å‘é€ç»™æµè§ˆå™¨ - å‘é€ body (html é¡µé¢æ•°æ®)
							self.new_socket.send(response_body) # ğŸš€ å‘é€ html äºŒè¿›åˆ¶æ•°æ®ç»™æµè§ˆå™¨

						# 9. å…³é—­è¿™ä¸ªæ–°å¥—æ¥å­— (ğŸ”¥ self.new_socket!!) â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”
						self.new_socket.close() # ğŸ”— å…³é—­çš„è¯, å°±æ˜¯çŸ­é“¾æ¥, å›¾ç‰‡é‚£äº›å¾—é‡æ–°è¯·æ±‚ (åˆå¾—é‡æ–°è¿›è¡Œä¸‰æ¬¡æ¡æ‰‹å››æ¬¡æŒ¥æ‰‹)

						if f is not None: # å¦‚æœæ–‡ä»¶å­˜åœ¨
							f.close()
				# ğŸ‘‡å¦‚æœæ˜¯ .py ç»“å°¾çš„è¯·æ±‚, å°±ç”ŸæˆåŠ¨æ€é¡µé¢ ************************************************************************
				else:
					# ğŸ‘‡æ›´å¥å£®, é¿å…åªèƒ½è¿”å› 200 OK, è€Œæ˜¯èƒ½åœ¨ web æ¡†æ¶ä¸­è®¾ç½® header å“åº”å¤´
					# response_body = application(file_name)
					response_body = application(self.set_status_headers) # ğŸ‘ˆğŸ‘ˆ ä¸å†™æ‹¬å·, ä¸æ˜¯è°ƒç”¨å‡½æ•°, è€Œæ˜¯æŠŠå‡½æ•°ä¼ å…¥ application å†…, åœ¨ application å†…å»è°ƒç”¨å¹¶ä¼ å…¥ header çš„çŠ¶æ€ç ç­‰ header å“åº” !!! response_body å°±æ˜¯ application çš„ return !!!
					response_header = "HTTP/1.1 %s\r\n" % {self.status}  # ğŸ‘ˆğŸ‘ˆ åˆå¹¶ header çš„çŠ¶æ€ç è·Ÿå“åº”	
					for headerContent in self.headers:
						response_header += "%s: %s\r\n" % (headerContent[0], headerContent[1]) # ğŸ‘ˆğŸ‘ˆ åˆå¹¶ header çš„å“åº”å¤´
					response_header += "\r\n"
					response = response_header + response_body # ğŸš€ å‚¨å­˜è¿”å›ç»™æµè§ˆå™¨çš„æ•°æ®
					self.new_socket.send(response.encode('utf-8'))  # encode('utf-8') ç”¨æ¥è½¬ä¸ºäºŒè¿›åˆ¶æ•°æ®ä¼ ç»™æµè§ˆå™¨
					self.new_socket.close()
     
					# ğŸ‘‡åšæŠ½è±¡, é¿å…æ¯å¢åŠ ä¸€ä¸ªé¡µé¢éƒ½è¦é‡å†™ä¸€éæœåŠ¡å™¨
     				# response_header = "HTTP/1.1 200 OK\r\nContent-Type: text/html; charset=utf-8\r\n"
					# response_header += "\r\n"
     
					# if file_name == '/login.py':
					# 	response_body = login()
					# 	self.new_socket.send(response_header.encode('utf-8')) # encode('utf-8') ç”¨æ¥è½¬ä¸ºäºŒè¿›åˆ¶æ•°æ®ä¼ ç»™æµè§ˆå™¨
					# 	self.new_socket.send(response_body.encode('utf-8')) # encode('utf-8') ç”¨æ¥è½¬ä¸ºäºŒè¿›åˆ¶æ•°æ®ä¼ ç»™æµè§ˆå™¨
					# elif file_name == "/detail.py":
					# 	response_body = detail()
					# 	self.new_socket.send(response_header.encode('utf-8')) # encode('utf-8') ç”¨æ¥è½¬ä¸ºäºŒè¿›åˆ¶æ•°æ®ä¼ ç»™æµè§ˆå™¨
					# 	self.new_socket.send(response_body.encode('utf-8')) # encode('utf-8') ç”¨æ¥è½¬ä¸ºäºŒè¿›åˆ¶æ•°æ®ä¼ ç»™æµè§ˆå™¨
					# elif file_name == "/register.py":
					# 	response_body = register()
					# 	self.new_socket.send(response_header.encode('utf-8')) # encode('utf-8') ç”¨æ¥è½¬ä¸ºäºŒè¿›åˆ¶æ•°æ®ä¼ ç»™æµè§ˆå™¨
					# 	self.new_socket.send(response_body.encode('utf-8')) # encode('utf-8') ç”¨æ¥è½¬ä¸ºäºŒè¿›åˆ¶æ•°æ®ä¼ ç»™æµè§ˆå™¨
					# else :
					# 	response_body = wrong_404() # 404 å…œåº•é¡µ
					# 	self.new_socket.send(response_header.encode('utf-8')) # encode('utf-8') ç”¨æ¥è½¬ä¸ºäºŒè¿›åˆ¶æ•°æ®ä¼ ç»™æµè§ˆå™¨
					# 	self.new_socket.send(response_body.encode('utf-8')) # encode('utf-8') ç”¨æ¥è½¬ä¸ºäºŒè¿›åˆ¶æ•°æ®ä¼ ç»™æµè§ˆå™¨

     

def main():
    http_server = WSGIServer(8080, './html') # ğŸ”¥ä¼ å…¥ç«¯å£ + æ–‡ä»¶å¤¹çš„æ ¹è·¯å¾„
    http_server.run_forever() # ğŸ”¥ ä¸€ç›´è¿è¡Œç¨‹åº


if __name__ == "__main__": # å½“è¿™ä¸ªè„šæœ¬è¢«ç›´æ¥è¿è¡Œæ—¶ï¼ˆè€Œä¸æ˜¯è¢«å…¶ä»–è„šæœ¬å¯¼å…¥ï¼‰ï¼Œè°ƒç”¨ main() å‡½æ•°ï¼Œæ‰§è¡Œä¸»è¦åŠŸèƒ½
	main()
